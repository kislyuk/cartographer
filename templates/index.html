<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

    <script src="http://code.jquery.com/jquery-1.10.1.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="/static/lib/mousetrap.min.js"></script>

    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #container {position: absolute; top: 0; left: 0; width: 100%; height: 100%;}
      #map-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%;}
      #cartographer-root {
        position: relative;
        top: 0px; left: 15%;
        width: 70%; height: 200px;
        background-color: white; opacity: 0.9;
        border: 1px solid gray;
        border-top: none;
        border-bottom-right-radius: 5px;
        border-bottom-left-radius: 5px;
        padding: 8px;
        font-family: sans-serif;
      }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD089xhNV3EkR5nv-GXTN0Mug87RWpe_iA&sensor=true">
    </script>
    <script type="text/javascript">
      google.maps.visualRefresh = true;
      var activeWindow = null;
      var cartographerOpen = true;
      var markers = {};

      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(-34.397, 150.644),
          zoom: 8,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);

        var marker_image = 'http://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Wikipedia%27s_W.svg/17px-Wikipedia%27s_W.svg.png';

        function updateMarkers() {
          var bounds = map.getBounds();
          var mapNE = bounds.getNorthEast();
          var mapSW = bounds.getSouthWest();

          var seenTitles = [];
//          _.each(_.keys(markers), function(marker) {
          _.each(markers, function(marker, name) {
            if (bounds.contains(marker.getPosition())) {
              seenTitles.push(name);
            } else {
              marker.setMap(null);
              //markers[marker].setMap(null);
              delete markers[marker];
              console.log("Deleted "+marker);
            }
          });
//          console.log("Seen "+seenTitles.length+" titles:");
//          console.dir(seenTitles);
//                       function check_is_in_or_out(marker){
//   return map.getBounds().contains(marker.getPosition());
// }


          console.log("Bounds changed to: ");
          console.dir(mapNE.lat());
          console.dir(mapNE.lng());
          console.dir(mapSW.lat());
          console.dir(mapSW.lng());

          function plotMarkers(data) {
            _.each(data.points, function(point) {
              var myLatLng = new google.maps.LatLng(point.lat, point.lng);

              var marker = new google.maps.Marker({position: myLatLng,
                                                   map: map,
                                                   icon: marker_image,
                                                   title: point.name});
              var infowindow = new google.maps.InfoWindow({
                content: '<a href="https://en.wikipedia.org/wiki/' + point.name + '"><h1>' + point.name + '</h1></a><p>' +point.abstract + '</p>'
              });
              google.maps.event.addListener(marker, 'click', function() {
                if (activeWindow) {
                  activeWindow.close();
                }

                infowindow.open(map, marker);
                activeWindow = infowindow;
              });
//              markers.push(marker);
              markers[point.name] = marker;
//              console.dir(point);
            });
//            console.dir(data)
          }

          $.ajax('/getPoints',
                 {type: 'POST',
                  contentType : 'application/json',
                  data : JSON.stringify({NE: [mapNE.lng(), mapNE.lat()],
                                         SW: [mapSW.lng(), mapSW.lat()],
                                         seen: seenTitles}),
                  success: plotMarkers});
        }

        Mousetrap.bind('esc', function() {
          console.log("Escape!");
          if (activeWindow) {
            activeWindow.close();
            activeWindow = null;
          }
        });
        Mousetrap.bind(['`', '~'], function() {
          if (cartographerOpen) {
            $('#cartographer-root').slideUp(150);
            cartographerOpen = false;
          } else {
            $('#cartographer-root').slideDown(150);
            cartographerOpen = true;
          }
        });
        google.maps.event.addListener(map, 'idle', updateMarkers);
      }
      google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="container">
      <div id="map-container">
        <div id="map-canvas"/>
      </div>

      <div id="cartographer-root">
        Cartographer - Social Mapping
      </div>
    </div>
  </body>
</html>
